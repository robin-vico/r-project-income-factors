---
title: "prediction"
author: "Robin VICO"
date: "2025-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Step 4: Modeling and Prediction (Data Science)

Preparing Data for Modeling: Convert all remaining categorical variables into "dummy" variables (one-hot encoding) so they can be used by the models.

```{r}
library(dplyr)
library(caret)
data_for_model <- read.csv('data/processed/clean_v1.csv') %>% 
  mutate(income = factor(income, labels = c("L50K", "G50K"))) 

categorical_vars <- names(data_for_model)[
  (sapply(data_for_model, is.factor) | sapply(data_for_model, is.character)) & 
  names(data_for_model) != "income"
]

if (length(categorical_vars) == 0) {
  stop("Errorr: No categorical variable was found.")
}

formula_vars <- paste(categorical_vars, collapse = " + ")

dummies <- dummyVars(paste("~", formula_vars), data = data_for_model)

encoded_data <- data.frame(predict(dummies, newdata = data_for_model))

final_data_encoded <- bind_cols(
  data_for_model %>% select_if(is.numeric),
  encoded_data,
  income = data_for_model$income
)

set.seed(42)
train_index <- createDataPartition(final_data_encoded$income, p = 0.7, list = FALSE)

training_set <- final_data_encoded[train_index, ]
testing_set <- final_data_encoded[-train_index, ]
```

Training the models :

```{r, eval = FALSE}
logistic_model <- glm(income ~ ., 
                      data = training_set, 
                      family = "binomial")

print("Logistic regression model training success.")

dir.create("models", showWarnings = FALSE)
saveRDS(logistic_model, file = "models/logistic_model.rds")
```

```{r}
logistic_model_loaded = readRDS("models/logistic_model.rds")
```

```{r, eval=FALSE}
library(randomForest)

fit_control <- trainControl(method = "cv", # Validation croisée
                            number = 5,   # 5 plis
                            classProbs = TRUE, # Nécessaire pour l'AUC
                            summaryFunction = twoClassSummary,
                            verboseIter = TRUE)

rf_model <- train(income ~ ., 
                  data = training_set, 
                  method = "rf", 
                  trControl = fit_control,
                  metric = "ROC") # Optimiser sur l'AUC (ROC)

dir.create("models", showWarnings = FALSE)
saveRDS(rf_model, file = "models/rf_model.rds")
```

```{r}
rf_model_loaded = readRDS(file = "models/rf_model.rds")
```

predictions :

```{r}
lr_predictions <- predict(logistic_model_loaded, testing_set, type = "response")
lr_predicted_class <- factor(ifelse(lr_predictions > 0.5, "G50K", "L50K"), levels = c("L50K", "G50K"))


rf_predictions <- predict(rf_model_loaded, testing_set)


rf_probs <- predict(rf_model_loaded, testing_set, type = "prob")
```

```{r}
library(pROC)

lr_predictions <- predict(logistic_model_loaded, testing_set, type = "response")

lr_predicted_class <- factor(ifelse(lr_predictions > 0.5, "G50K", "L50K"), 
                             levels = c("L50K", "G50K"))
lr_conf_matrix <- confusionMatrix(lr_predicted_class, testing_set$income)

print(lr_conf_matrix)

lr_conf_matrix <- confusionMatrix(lr_predicted_class, testing_set$income)
lr_auc <- roc(testing_set$income, lr_predictions, levels = c("L50K", "G50K"))

print("--- Logistic regression evaluation ---")
print(lr_conf_matrix)
cat("AUC Score:", lr_auc$auc, "\n\n")


rf_conf_matrix <- confusionMatrix(rf_predictions, testing_set$income)
rf_auc <- roc(testing_set$income, rf_probs$G50K, levels = c("L50K", "G50K"))

print("--- Random Forest evaluation ---")
print(rf_conf_matrix)
cat("AUC Score:", rf_auc$auc, "\n\n")
```

```{r}
rf_importance <- varImp(rf_model_loaded, scale = FALSE)

top_5_features <- head(
  rf_importance$importance[order(-rf_importance$importance$Overall), , drop = FALSE], 
  5
)

print("--- Top 5 most important variables (Random Forest) ---")
print(top_5_features)
```
